<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–†–ê–°–ö–†–ê–°–ö–ê –ü–û –û–¢–í–ï–¢–ê–ú ‚Äî –†–µ–¥–∞–∫—Ç–æ—Ä</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        :root { --bg: #050817; --panel: #0b1126; --text: #f1f5f9; --primary: #c084fc; --accent: #38bdf8; --line: #1e293b; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 420px 1fr; overflow: hidden; }
        
        .header-main { grid-column: 1 / -1; height: 80px; background: #020617; display: flex; align-items: center; justify-content: center; gap: 20px; border-bottom: 2px solid var(--primary); box-shadow: 0 0 15px rgba(192, 132, 252, 0.4); z-index: 10; }
        .header-main h1 { font-size: 30px; font-weight: 900; color: #fff; margin: 0; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px var(--primary); }
        .logo-img { height: 55px; border-radius: 50%; border: 2px solid var(--primary); }

        .sidebar { background: var(--panel); border-right: 1px solid var(--line); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .section { margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid var(--line); }
        h3 { margin: 0 0 10px; font-size: 11px; text-transform: uppercase; color: var(--accent); }
        
        input, textarea, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--line); background: #161e3d; color: #fff; margin-bottom: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: 0; cursor: pointer; font-weight: bold; background: var(--primary); color: #000; margin-top: 5px; }
        .btn:hover { filter: brightness(1.2); }

        .canvas-area { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #020617; padding: 20px; overflow: hidden; }
        .frame { position: relative; line-height: 0; border-radius: 10px; transition: 0.3s; background: #000; }
        #mainImg { max-width: 100%; max-height: 65vh; display: block; pointer-events: none; }
        #mainSvg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }

        #preview-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); display: none; z-index: 5; }
        .footer-credit { position: absolute; bottom: 10px; right: 20px; font-size: 12px; color: var(--accent); font-weight: bold; }
        .list-item { background: #161e3d; padding: 8px; border-radius: 6px; margin-bottom: 5px; font-size: 12px; border: 1px solid var(--line); }
    </style>
</head>
<body>

<div class="header-main">
    <img src="https://i.ibb.co/q345VSpm/5291888536539828600.jpg" class="logo-img">
    <h1>–†–ê–°–ö–†–ê–°–ö–ê –ü–û –û–¢–í–ï–¢–ê–ú</h1>
</div>

<div class="sidebar">
    <div class="section">
        <h3>1. –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏ –°—Ç–∏–ª—å</h3>
        <select id="imgPreset" onchange="loadPreset()">
            <option value="">-- –ì–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã --</option>
            <option value="https://i.ibb.co/jvj9q36b/c8fae767598537c00255e117f9b1199b.jpg">–ú–∏–ª—ã–π –µ–¥–∏–Ω–æ—Ä–æ–≥</option>
            <option value="https://i.ibb.co/GqxzQ5c/2026-02-16-234253.png">–°–æ–≤—É–Ω—å—è</option>
            <option value="https://i.ibb.co/XZfDj366/2026-02-16-234445.png">–ë–∞—Ä–±–æ—Å–∫–∏–Ω—ã</option>
            <option value="https://i.ibb.co/ch9R8Lbd/Avatar-Jake-Sully-and-Neytiri.png">–ê–≤–∞—Ç–∞—Ä</option>
        </select>
        <input type="file" id="fileInp" accept="image/*">
        <div style="display:flex; gap:10px;">
            <div><label style="font-size:9px;">–¶–í–ï–¢ –¢–ï–ö–°–¢–ê</label><input type="color" id="fontColor" value="#ffffff"></div>
            <div><label style="font-size:9px;">–ù–ï–û–ù –†–ê–ú–ö–ò</label><input type="color" id="glowColor" value="#c084fc"></div>
        </div>
    </div>

    <div class="section">
        <h3>2. –û–±–≤–æ–¥–∫–∞ –∏ –ó–∞–¥–∞–Ω–∏–µ</h3>
        <textarea id="taskInp" placeholder="–ó–∞–¥–∞–Ω–∏–µ (–º–æ–∂–Ω–æ LaTeX)"></textarea>
        <input type="text" id="ansInp" placeholder="–û—Ç–≤–µ—Ç">
        <div style="display:flex; align-items:center; gap:10px;">
            <input type="color" id="colorInp" value="#ff4d6d">
            <button class="btn" style="background:#475569; color:#fff;" onclick="undoPoint()">–®–∞–≥ –Ω–∞–∑–∞–¥</button>
        </div>
        <button class="btn" onclick="saveRegion()">–°–û–•–†–ê–ù–ò–¢–¨ –û–ë–õ–ê–°–¢–¨</button>
    </div>

    <div id="regList" style="max-height: 150px; overflow-y: auto; margin-bottom: 10px;"></div>

    <div class="section">
        <h3>4. –≠–∫—Å–ø–æ—Ä—Ç</h3>
        <button class="btn" style="background:var(--accent)" onclick="buildGame()">–ü–†–ï–î–ü–†–û–°–ú–û–¢–† –ò –ö–û–î</button>
        <textarea id="output" style="height:50px; font-size:10px; margin-top:10px;" readonly placeholder="–ö–æ–¥ –¥–ª—è Genially –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
    </div>
</div>

<div class="canvas-area">
    <div id="preview-overlay">
        <button onclick="closePreview()" style="position:absolute; top:10px; right:10px; z-index:10; background:red; color:white; border:0; padding:5px 15px; border-radius:5px; cursor:pointer;">–ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
        <iframe id="preview-iframe" style="width:100%; height:100%; border:0;"></iframe>
    </div>
    
    <div class="frame" id="frameBox">
        <img id="mainImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <svg id="mainSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    </div>
    <div class="footer-credit">–£—Ä–æ–∫–∏ –Ω–∞ –í–°–ï —Å–ª—É—á–∞–∏ ‚Ä¢ Genially</div>
</div>

<script>
    let points = []; let regions = []; let currentImg = "";

    // –°–º–µ–Ω–∞ —Ä–∞–º–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    document.getElementById('glowColor').oninput = (e) => {
        document.getElementById('frameBox').style.boxShadow = `0 0 30px ${e.target.value}`;
        document.getElementById('frameBox').style.border = `3px solid ${e.target.value}`;
    };

    function loadPreset() {
        const url = document.getElementById('imgPreset').value;
        if(url) { currentImg = url; document.getElementById('mainImg').src = url; }
    }

    document.getElementById('fileInp').onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => { currentImg = ev.target.result; document.getElementById('mainImg').src = ev.target.result; };
        reader.readAsDataURL(file);
    };

    document.getElementById('mainSvg').onclick = (e) => {
        const rect = document.getElementById('mainSvg').getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 1000;
        const y = ((e.clientY - rect.top) / rect.height) * 1000;
        points.push({x, y}); draw();
    };

    function draw() {
        let h = '';
        if(points.length > 0) {
            const path = points.map(p => p.x + ',' + p.y).join(' ');
            h += `<polyline points="${path}" fill="none" stroke="#fff" stroke-width="3" />`;
            points.forEach(p => h += `<circle cx="${p.x}" cy="${p.y}" r="4" fill="red" />`);
        }
        regions.forEach(r => {
            const path = r.points.map(p => p.x + ',' + p.y).join(' ');
            h += `<polygon points="${path}" fill="${r.color}66" stroke="${r.color}" stroke-width="1" />`;
        });
        document.getElementById('mainSvg').innerHTML = h;
    }

    function undoPoint() { points.pop(); draw(); }

    function saveRegion() {
        const t = document.getElementById('taskInp').value;
        const a = document.getElementById('ansInp').value;
        const c = document.getElementById('colorInp').value;
        if(!t || !a || points.length < 3) return alert("–û–±–≤–µ–¥–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
        regions.push({ task: t, answer: a, color: c, points: [...points] });
        points = []; draw(); updateList();
    }

    function updateList() {
        document.getElementById('regList').innerHTML = regions.map((r,i) => `
            <div class="list-item">‚Ññ${i+1}: ${r.answer} <span style="color:${r.color}">‚ñ†</span> 
            <button onclick="regions.splice(${i},1);updateList();draw()" style="float:right; border:0; background:none; color:red; cursor:pointer;">‚úñ</button></div>
        `).join('');
    }

    function closePreview() { document.getElementById('preview-overlay').style.display = 'none'; }

    function buildGame() {
        if(!currentImg || regions.length === 0) return alert("–î–æ–±–∞–≤—å—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –æ–±–ª–∞—Å—Ç—å!");
        
        const cfg = {
            glow: document.getElementById('glowColor').value,
            fColor: document.getElementById('fontColor').value,
            img: currentImg,
            data: regions
        };

        const gameHtml = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
    <style>
        body { margin: 0; background: transparent; font-family: 'Segoe UI', sans-serif; height: 100vh; display: grid; grid-template-columns: 35% 65%; color: ${cfg.fColor}; overflow: hidden; }
        .side { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        #q-box { background: rgba(0,0,0,0.6); padding: 30px; border-radius: 25px; text-align: center; border: 3px solid ${cfg.glow}; box-shadow: 0 0 20px ${cfg.glow}55; width: 90%; }
        .frame { position: relative; border: 4px solid ${cfg.glow}; box-shadow: 0 0 30px ${cfg.glow}; border-radius: 15px; background: #000; line-height: 0; }
        img { max-width: 100%; max-height: 80vh; display: block; }
        svg { position: absolute; top:0; left:0; width:100%; height:100%; cursor: pointer; }
        input { width: 100%; padding: 15px; margin: 20px 0; border-radius: 12px; border: 0; font-size: 20px; text-align: center; outline: none; }
        .btn-check { background: ${cfg.glow}; color: #000; padding: 12px 40px; border-radius: 12px; cursor: pointer; font-weight: bold; border: 0; font-size: 18px; }
        .progress-bar { width: 100%; height: 12px; background: rgba(255,255,255,0.1); margin-top: 25px; border-radius: 6px; overflow: hidden; }
        #p-inner { height: 100%; background: ${cfg.glow}; width: 0%; transition: 0.5s; }
        .paint-can { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #fff; margin-top: 20px; display: none; cursor: pointer; animation: bounce 1s infinite; user-select:none; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        /* ‚úÖ —É–ª—É—á—à–µ–Ω–∏–µ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–æ–≤ */
        .ans-text { user-select:none; pointer-events:auto; }

        /* ‚úÖ –ø–ª–∞–≤–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∑–æ–Ω */
        .zone { transition: fill 0.55s ease, filter 0.35s ease, opacity 0.35s ease; }
        .zone:not(.solved):hover { fill: rgba(255,255,255,0.10) !important; filter: drop-shadow(0 0 8px rgba(255,255,255,0.25)); }
    </style>
</head>
<body>
    <div class="side">
        <div id="q-box">
            <div id="math-field" style="font-size: 32px; min-height: 50px;"></div>
            <input type="text" id="userAns" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç...">
            <button class="btn-check" onclick="checkAnswer()">–ü–†–û–í–ï–†–ò–¢–¨</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; min-height: 24px;"></div>
            <div id="p-can" class="paint-can" onclick="enablePainting()"></div>
            <div class="progress-bar"><div id="p-inner"></div></div>
        </div>
    </div>
    <div class="side"><div class="frame"><img src="${cfg.img}"><svg id="gSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg></div></div>
    <script>
        const data = ${JSON.stringify(cfg.data)};
        let curIdx = 0, canPaint = false, solved = [];

        // ‚úÖ –ì–†–£–ü–ü–ò–†–û–í–ö–ê: –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–ª–∞—Å—Ç–µ–π –º–æ–≥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –æ–¥–Ω–æ–º—É –∑–∞–¥–∞–Ω–∏—é
        const tasks = [];
        const taskMap = {};
        for(let i=0;i<data.length;i++){
            const k = (data[i].task + '||' + data[i].answer).toString();
            if(!taskMap[k]){
                taskMap[k] = { task: data[i].task, answer: data[i].answer, color: data[i].color, idxs: [] };
                tasks.push(taskMap[k]);
            }
            taskMap[k].idxs.push(i);
        }
        let curTask = 0;

        // ‚úÖ —É–ª—É—á—à–µ–Ω–∏–µ: —É–º–Ω–æ–µ –∞–≤—Ç–æ-—É–º–µ–Ω—å—à–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –æ–±–ª–∞—Å—Ç—å (–±–µ–∑ OCR, –ø–æ bbox)
        function getBBoxFromPoints(pts){
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            pts.forEach(p => { if(p.x < minX) minX = p.x; if(p.y < minY) minY = p.y; if(p.x > maxX) maxX = p.x; if(p.y > maxY) maxY = p.y; });
            return { minX, minY, maxX, maxY, w: (maxX-minX), h: (maxY-minY) };
        }
        function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
        function smartFontSize(pts, text){
            const b = getBBoxFromPoints(pts);
            const len = Math.max(1, (text || '').toString().length);
            const base = Math.min(b.w, b.h);
            let fs = base / (len <= 2 ? 2.8 : len <= 4 ? 3.6 : 4.6);
            fs = clamp(fs, 14, 44);
            return Math.round(fs);
        }

        function renderTask() {
            if(curTask >= tasks.length) {
                document.getElementById('q-box').innerHTML = '<h1 style="color:${cfg.glow}">–ì–ï–ù–ò–ê–õ–¨–ù–û! üéâ</h1><p>–í—ã —Ä–∞—Å–∫—Ä–∞—Å–∏–ª–∏ –≤—Å—ë!</p>';
                return;
            }
            const q = tasks[curTask];
            const field = document.getElementById('math-field');
            if(q.task.includes('\\\\') || q.task.includes('^') || q.task.includes('_')) {
                try { katex.render(q.task, field); } catch(e) { field.textContent = q.task; }
            } else { field.textContent = q.task; }
            document.getElementById('userAns').value = '';
            document.getElementById('p-can').style.display = 'none';
            document.getElementById('feedback').textContent = '';
            canPaint = false;
        }

        window.checkAnswer = () => {
            const val = document.getElementById('userAns').value.trim().toLowerCase();
            if(curTask >= tasks.length) return;
            if(val === tasks[curTask].answer.toLowerCase()) {
                document.getElementById('feedback').innerHTML = '‚úÖ –í–µ—Ä–Ω–æ! –ù–∞–∂–º–∏ –Ω–∞ –æ–±–ª–∞—Å—Ç—å —Å –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Ä–∏—Å—É–Ω–∫–µ ‚Üí';
                document.getElementById('p-can').style.backgroundColor = tasks[curTask].color;
                document.getElementById('p-can').style.display = 'inline-block';
                canPaint = true;
            } else { document.getElementById('feedback').textContent = '‚ùå –ù–µ–≤–µ—Ä–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑'; }
        };

        window.enablePainting = () => {
            canPaint = true;
            if(curTask < tasks.length) document.getElementById('feedback').textContent = 'üé® –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏ –Ω–∞ ' + tasks[curTask].answer + ' –Ω–∞ —Ä–∏—Å—É–Ω–∫–µ!';
        };

        function draw() {
            document.getElementById('gSvg').innerHTML = data.map((r, i) => {
                const s = solved.includes(i);
                const cx = r.points.reduce((a,b)=>a+b.x,0)/r.points.length;
                const cy = r.points.reduce((a,b)=>a+b.y,0)/r.points.length;

                const fs = smartFontSize(r.points, r.answer);

                return \`
                  <polygon
                    class="zone \${s ? 'solved' : ''}"
                    points="\${r.points.map(p=>p.x+','+p.y).join(' ')}"
                    fill="\${s ? r.color : 'rgba(0,0,0,0)'}"
                    stroke="#ddd"
                    onclick="clickR(\${i})"
                    style="cursor:pointer;"
                  />
                  <text
                    class="ans-text"
                    x="\${cx}" y="\${cy}"
                    font-size="\${fs}"
                    font-weight="900"
                    text-anchor="middle"
                    dominant-baseline="middle"
                    onclick="clickR(\${i})"
                    style="
                      cursor:pointer;
                      fill:${cfg.fColor};
                      stroke: rgba(0,0,0,0.85);
                      stroke-width: 5px;
                      paint-order: stroke;
                    "
                  >\${r.answer}</text>
                \`;
            }).join('');
        }

        window.clickR = (i) => {
            if(!canPaint) return;
            if(solved.includes(i)) return;
            if(curTask >= tasks.length) return;

            // ‚úÖ —Ä–∞–∑—Ä–µ—à–∞–µ–º –∫—Ä–∞—Å–∏—Ç—å –¢–û–õ–¨–ö–û –æ–±–ª–∞—Å—Ç–∏, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–µ —Ç–µ–∫—É—â–µ–º—É –∑–∞–¥–∞–Ω–∏—é
            const group = tasks[curTask];
            if(!group.idxs.includes(i)) return;

            solved.push(i);

            // ‚úÖ –µ—Å–ª–∏ –≤—Å–µ –æ–±–ª–∞—Å—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –∑–∞–∫—Ä–∞—à–µ–Ω—ã ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É
            const doneAll = group.idxs.every(idx => solved.includes(idx));
            if(doneAll) {
                curTask++;
                canPaint = false;
                renderTask();
            }

            document.getElementById('p-inner').style.width = (solved.length/data.length*100)+'%';
            draw();
        };

        renderTask(); draw();
    <\/script>
</body>
</html>`;

        // –í—ã–≤–æ–¥ –∫–æ–¥–∞ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        const iframe = document.getElementById('preview-iframe');
        iframe.srcdoc = gameHtml;
        document.getElementById('preview-overlay').style.display = 'block';
        document.getElementById('output').value = `<iframe srcdoc="${gameHtml.replace(/"/g, '&quot;')}" width="100%" height="600" style="border:0;" allowtransparent="true"></iframe>`;
    }
</script>
</body>
</html>
